<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for index.js</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="prettify.css" />
    <link rel="stylesheet" href="base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="index.html">All files</a> index.js
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">78.95% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>60/76</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">48.78% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>20/41</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">75% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>9/12</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">81.08% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>60/74</span>
      </div>
    </div>
  </div>
  <div class='status-line medium'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309</td><td class="line-coverage quiet"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3x</span>
<span class="cline-any cline-yes">3x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3x</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3x</span>
<span class="cline-any cline-yes">3x</span>
<span class="cline-any cline-yes">3x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">40x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">40x</span>
<span class="cline-any cline-yes">40x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">40x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">40x</span>
<span class="cline-any cline-yes">2x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">40x</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">40x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">40x</span>
<span class="cline-any cline-yes">2x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">40x</span>
<span class="cline-any cline-yes">78x</span>
<span class="cline-any cline-yes">78x</span>
<span class="cline-any cline-yes">78x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">78x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">80x</span>
<span class="cline-any cline-yes">40x</span>
<span class="cline-any cline-yes">40x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">80x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3x</span>
<span class="cline-any cline-yes">2x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2x</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3x</span>
<span class="cline-any cline-yes">2x</span>
<span class="cline-any cline-yes">2x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2x</span>
<span class="cline-any cline-yes">2x</span>
<span class="cline-any cline-yes">40x</span>
<span class="cline-any cline-yes">40x</span>
<span class="cline-any cline-yes">40x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">import React, {useRef, useState} from 'react';
import Indicator from './indicator';
import Measurer from './measurer';
import useScroll from './useScroll';
&nbsp;
import styles from './styles.css';
&nbsp;
const INITIAL_ITEM_HEIGHT = 10;
&nbsp;
const INDICATOR_BAR_HEIGHT = 60;
&nbsp;
const findNearest = <span class="fstat-no" title="function not covered" >(m</span>in, max, test) =&gt;{
<span class="cstat-no" title="statement not covered" >  while (min &lt;= max) {</span>
    const mid = <span class="cstat-no" title="statement not covered" >min + Math.floor((max - min) / 2);</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >    switch (test(mid)) {</span>
      case "eq" : <span class="cstat-no" title="statement not covered" >return mid;</span>
      case 'lt' : <span class="cstat-no" title="statement not covered" >max = mid - 1; <span class="cstat-no" title="statement not covered" ></span>break;</span>
      case 'gt' : <span class="cstat-no" title="statement not covered" >min = mid + 1; <span class="cstat-no" title="statement not covered" ></span>break;</span>
      default:
<span class="cstat-no" title="statement not covered" >        throw Error('invalid return')</span>
    }
  }
&nbsp;
<span class="cstat-no" title="statement not covered" >  return (min &gt; 0) ? min - 1 : 0;</span>
};
&nbsp;
// ### Note: List是如何进行渲染的
// 
// #### 首次（首屏）渲染
// 首次渲染时，List需要知道viewport范围内待渲染条目的index范围。而想要
// 知道这个范围我们必须要先知道每个条目的高度，而想要知道高度必须得依据
// **已经渲染了的**条目的DOM。所以首次渲染只能先给定一个大概的条目的高度，
// 在进行渲染之后，让条目在一个useEffect中更新其高度，并通知回List。
// 
// #### 滚动时重新渲染
// 在滚动的过程中我们不断渲染新的条目，然而经过reconciliation，不会有频繁的
// 条目增删操作。但是每个条目的偏移和高度都会计算并保存下来。
// 
// #### spontaneous重新渲染
// 如果某些组件会通过其他方式，譬如textarea resizing，或者带有添加或删除
// 项目元素的交互功能，那么也需要重新渲染。
// 
// 
// 特别重要：对于List控制重新渲染的途径只有一个，就是下方的updateOverallHeight。
// updateOverallHeight是最外层List的唯一参数，因此如果不更新overallHeight状态
// 就无法rerender。同时，由于所有List元素的高度及变化都会反映在OverallHeight
// 上，因此完全由overallHeight控制能保证所有元素在各种情况下发生高度变化时都能
// 重新渲染。（正确性及唯一性）
// 
export default ({itemData=<span class="branch-0 cbranch-no" title="branch not covered" >[],</span> Row, height:outerHeight, overscan=<span class="branch-0 cbranch-no" title="branch not covered" >10,</span> children}) =&gt; {
&nbsp;
  const itemCount = itemData.length;
&nbsp;
  const {
    isScrolling,
    scrollOffsetDelta,
    scrollOffset,
    // setScrollOffset,
    onScroll,
  } = useScroll();
&nbsp;
  // **为什么在这里使用useRef而不是useState?**
  // 
  // useState有两个问题，首先setState的更新被送入一个队列，因此即使是与顺序无关的操作
  // 也会被强行变为顺序执行。其次每次setState都会造成re-rendering，但是对我们来说并不
  // 需要。
  // 
  // 而useRef则在hook中创建了一个mutable的数据结构，使得它不会受到re-rendering（也就
  // 是本函数重新执行的影响）我们可以直接向它异步地赋值。但是下方我们写了若干个引用变
  // 量，在每次re-rendering后这些变量也会跟着更新，因此可以把它们放在useEffect中，这
  // 样我们就可以在useEffect中实现节流/防抖的操作了。
  // 
  const dataRef = useRef({
    bounds: {},
    currentBottom: -1, 
    measuredBottom: -1, 
    itemsTop:0,
    itemsHeight: 0,
  });
&nbsp;
  const calcOverallHeight = () =&gt; {
    const {
      itemsHeight,
      itemsTop,
      measuredBottom,
    } = dataRef.current;
    return itemsTop + itemsHeight + (itemCount - measuredBottom + 1) * INITIAL_ITEM_HEIGHT
  };
&nbsp;
  const [overallHeight, setOverallHeight] = useState(calcOverallHeight());
  
  const updateOverallHeight = <span class="fstat-no" title="function not covered" >()</span> =&gt; {
<span class="cstat-no" title="statement not covered" >    setOverallHeight(calcOverallHeight());</span>
  }
&nbsp;
  const getIndicatorPosition = () =&gt; {
    const margin = 3;
    return margin + scrollOffset / (overallHeight - outerHeight) * (outerHeight - INDICATOR_BAR_HEIGHT - INITIAL_ITEM_HEIGHT - margin)
  }
&nbsp;
  // # setItemHeight
  // 
  // **为什么只在这里更新currentBottom，而不直接调用下面那个updatePositionsTo？**
  // 
  // 因为updatePositionsTo开销较大，而我们并不确定setItemHeight被调用的顺序（它
  // 通常是由ResizeObserver的callback触发的，应当被看作异步操作）。因此我们设法将若
  // 干个item的位置计算集中到一次进行。详见下方useEffect。
  // 
  // **为什么不把currentBottom设为state而要存在ref里？**
  // 
  // setItemHeight由ResizeObserver发起，是异步和乱序的调用，而currentBottom只
  // 保留发起setItemHeight所有元素中index最小的那一个，和调用的顺序无关。如果
  // currentBottom是state，则意味着每次调用都会导致re-rendering，显然是多余的。
  // 在ref中保存的数据改变时不会触发re-render，是完美的hook中保存异步读写数据的
  // 方案。事实上我们会通过**节流**，使得尽量在一波setItemHeight结束后在进行re-
  // render。
 
  /**
   * ## setItemHeight
   * 
   * 计算条目高度，通过Measurer调用。
   * 
   * @param {number} index 
   * @param {number} height 
   */
  const setItemHeight = (currHeight, {index, measured}) =&gt; {
    // 1. **handling measureBottom &amp; itemsHeight**
    <span class="missing-if-branch" title="if path not taken" >I</span>if (index &lt;= dataRef.current.measuredBottom){
      //    *  index within the measuredBottom, which means we are updating the height of
    //       a rendered item. Apply the difference of the curr &amp; prev to overalHeight.
      const prevHeight = <span class="cstat-no" title="statement not covered" >dataRef.current.bounds[index].height;</span>
<span class="cstat-no" title="statement not covered" >      dataRef.current.itemsHeight += currHeight - prevHeight;</span>
&nbsp;
&nbsp;
    } else {
      // console.log('measure NEW', index, currHeight);
    //    *  index below the measuredBottom, which indicates that the element is just
    //       rendered and not measured yet. We update the newly conquered frontier,
    //       and the itemsHeight here.
      dataRef.current.measuredBottom = index;
      dataRef.current.itemsHeight += currHeight;
    }
&nbsp;
    dataRef.current.bounds[index].height = currHeight;
&nbsp;
    // 2. **invalidate all element positions below _index_. **
    // 
    //    New positions will be calculated when any of
    //    them is referred later.
    if (index &lt; dataRef.current.currentBottom) {
      dataRef.current.currentBottom = index;
    }
&nbsp;
    <span class="missing-if-branch" title="if path not taken" >I</span>if (measured) {
<span class="cstat-no" title="statement not covered" >      updateOverallHeight();</span>
    }
  }
&nbsp;
  // ## `updatePositionsTo`:
  // **为什么是从currentBottom到dest，而不是到measuredBottom？**
  // 
  // 考虑这样一个情景，我们需要用这个组件来渲染五百万行数据，并且这五百万行数据我们
  // 非常有耐心地拉到了底。此时measuredBottom就是4,999,999。然后第二行数据的高度增
  // 加了2px。如果是到measuredBottom，那么我们就必须要在下面的for循环中更新从第三行
  // 到第五百万行的位置。这显然没有必要，而应该是拉到哪里更新到哪里，因此这里是dest，
  // 也就是我们渲染的下边界的index。
  // 
  // **为什么不在这里面设置measuredBottom和itemsHeight？**
  //  
  // a) 我们需要在首次渲染之前就知道要渲染哪些元素，而测量过程要等到创建了Items之后
  //    才会调用。
  // 
  // b) 在后续的渲染中，因为这两个在调用setItemHeight的时候就都设置过了。由于在
  //    setItemHeight中标记了markUpdate，也就是说会确保强制刷新，因此在下次用到
  //    updatePositionsTo时不会有别的对这两个值的操作。
  // 
  // **为什么要重新获得一份currentBottom？**
  // 
  // a) 因为在Use
&nbsp;
  /**
   * ## updatePositionsTo
&nbsp;
   * 更新一定范围内的元素位置，仅被getItemBound调用。
   * 
   * @param {Integer} dest 要更新到的index
   */
  const updatePositionsTo = (dest, from) =&gt; {
    // console.log('updatePositionsTo', dest, from)
    const {currentBottom, itemsTop, bounds} = dataRef.current;
&nbsp;
    if (currentBottom &lt; 0) {
      dataRef.current.bounds[0] = {
        top: itemsTop,
        height: INITIAL_ITEM_HEIGHT,
        bottom: INITIAL_ITEM_HEIGHT + itemsTop};
    };
&nbsp;
    for (let i = Math.max(0, currentBottom); i &lt;= dest; i++) {
      const top = i === 0 ? itemsTop : bounds[i-1].bottom;
      const height = bounds[i] &amp;&amp; bounds[i].height || INITIAL_ITEM_HEIGHT
      const bottom =  top + height;
&nbsp;
      // console.log(`top: ${top} | height: ${height} | bottom: ${bottom}`);
&nbsp;
      dataRef.current.bounds[i] = { top, height, bottom };
    }
  }
&nbsp;
  const getItemBound = (index) =&gt; {
&nbsp;
    // case that currentBottom is previously set by setItemHeight,
    // which means the positions of items below are invalidated, and
    // need to be calculated again.
    if (index &gt; dataRef.current.currentBottom) {
      updatePositionsTo(index, 'GET-ITEM-BOUND');
      dataRef.current.currentBottom = index;
    }
&nbsp;
    return dataRef.current.bounds[index];
  };
  
  const getStartIndex = () =&gt; {
    const {measuredBottom, itemsHeight} = dataRef.current;
    
    const test = <span class="fstat-no" title="function not covered" >(i</span>ndex) =&gt; {
      const {top:curr} = <span class="cstat-no" title="statement not covered" >getItemBound(index);</span>
<span class="cstat-no" title="statement not covered" >      return curr &gt; scrollOffset ? 'lt' : curr &lt; scrollOffset ? 'gt' : 'eq';</span>
    }
&nbsp;
    const start = (scrollOffset &lt; itemsHeight)
      ? <span class="branch-0 cbranch-no" title="branch not covered" >findNearest(0, measuredBottom, test) </span>
      : measuredBottom + 1;
&nbsp;
    const overscanBack = !isScrolling
      ? overscan
      : <span class="branch-1 cbranch-no" title="branch not covered" >scrollOffsetDelta &lt; 0</span>
      ? overscan : 1;
&nbsp;
    return {
      start,
      overStart: Math.max(0, start - overscanBack)
    }
  }
&nbsp;
&nbsp;
  const getStopIndex = (startIndex, itemCount)=&gt; {
    
    const {bottom} = getItemBound(startIndex);
&nbsp;
    let offset, stop;
    for (
      stop = startIndex, offset = bottom;
      stop &lt; itemCount - 1 &amp;&amp; offset &lt; scrollOffset + outerHeight;
      stop += 1, offset += getItemBound(stop).height
    ) {
    };
&nbsp;
    const overscanFore = !isScrolling
    ? overscan
    : <span class="branch-1 cbranch-no" title="branch not covered" >scrollOffsetDelta &gt; 0</span>
    ? overscan : 1;
&nbsp;
    return {
      stop: Math.min(itemCount - 1, stop),
      overStop : Math.max(0, Math.min(itemCount - 1, stop + overscanFore))
    }
  }
&nbsp;
  const renderItems = () =&gt; {
&nbsp;
    if (itemData.length &gt; 0){
      const {overStart: start} = getStartIndex();
      const {overStop:  stop} = getStopIndex(start, itemData.length)
&nbsp;
      const items = [];
      for (let index = start; index &lt;= stop; index++) {
        const bound = getItemBound(index);
        const {height} = bound;
        items.push(&lt;Measurer {...{key:index, height, callback:setItemHeight, index}}&gt;
          &lt;Row {...{index, data: itemData[index], style:{...bound, position:'absolute'}}} /&gt;
        &lt;/Measurer&gt;)
      }
      // console.log(items.length, 'render items', start, stop);
      return items;
    } else {
      return [];
    }
  };
  
  const innerStyle = {
    position:'relative',
    height: overallHeight
  }
  return &lt;div style={{position:'relative', height:outerHeight, overflow:'hidden'}}&gt;
    &lt;div id="scrollView" className={styles.outer} {...{style: {overflowY:'scroll', height:outerHeight}, onScroll}}&gt;
      &lt;div style={{position:'sticky', top:'0', height:'auto', zIndex: 10}}&gt;
        {children}
      &lt;/div&gt;
      &lt;div className='inner-marker' style={innerStyle} &gt;{renderItems()} &lt;/div&gt;
    &lt;/div&gt;
    &lt;Indicator {...{
      barHeight: INDICATOR_BAR_HEIGHT,
      offset: getIndicatorPosition(),
      isScrolling,
    }}  /&gt;
  &lt;/div&gt;
}</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="https://istanbul.js.org/" target="_blank">istanbul</a> at Tue Jul 14 2020 14:37:58 GMT+0800 (China Standard Time)
</div>
</div>
<script src="prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="sorter.js"></script>
</body>
</html>
